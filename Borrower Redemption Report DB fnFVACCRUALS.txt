USE [fi71w08s12-icg-sql]
GO
/****** Object:  UserDefinedFunction [dbo].[fnFVACCRUALS]    Script Date: 02/19/2016 11:31:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER                    FUNCTION [dbo].[fnFVACCRUALS]
(
@dtDATE DATETIME,
@strTYPE CHAR(20),
@strINVESTMENTINS CHAR(32),
@strMODE CHAR(20)
)
RETURNS MONEY
AS
BEGIN
DECLARE @RESULT MONEY
/*Version 1.0.0
MODIFIED 19 JAN 2007 TO ALLOW FOR CAIADJ AND TO CORRECT AN ISSUE WITH DECACDPIK ETC. SIGNS*/
/*
NOW BUILD A TABLE OF PRINCIPAL FOR THE INVESTMENT INSTRUMENT FOR UNCLOSED ROLLOVERS AT THE REQUESTED DATE
MUST INCLUDE ALL PRIOR TRANSACTIONS IN ORDER TO COMPUTE OPENING PRINCIPAL AMOUNTS
MODIFIED JULY 2007 TO INCLUDE PREFERENCE SHARE (PEQ/SEQ)
MODIFIED MAY 2008 TO HANDLE DWO TRANSACTIONS
MODIFIED JANUARY 2013 TO HANDLE ACCRUALS FOR 360/360 BASIS LOANS
*/

/*
Get the interest basis for this instrument so we can do special processing for 360/360 basis loans
*/
DECLARE @INTERESTBASIS INTEGER
SET @INTERESTBASIS=(SELECT TOP 1 DAYSPERYEAR FROM VCINVESTINSRATE WHERE INVESTMENTINS=(SELECT ACCOUNTINS FROM VCINVESTMENTINS WHERE VCINVESTMENTINS.IQID=@strINVESTMENTINS) AND LASTDATE>=@dtDATE ORDER BY LASTDATE DESC)
DECLARE @dtSTARTFROM DATETIME
DECLARE @dtINITIALADVANCE DATETIME
--DECLARE @INITIALADVANCE FLOAT(15)
DECLARE @ACCRUALPERIODDAYS INTEGER
DECLARE @ACCID CHAR(32)
DECLARE @LASTTRANSACTIONCLOSEDATE DATETIME
/* FIND THE @ACCID WE ARE DEALING WITH */
SET @ACCID=(SELECT TOP 1 ACCOUNT FROM ADMUSER WHERE iqid IN (SELECT USERID FROM ADMDYNROLE WHERE ROLEID IN(
(SELECT TOP 1 IQREGIONID FROM VCINVESTMENTOP WHERE 
INVESTMENTINS=@strINVESTMENTINS
AND ISNULL(IQDELETED,0)=0
AND ISNULL(CANCELLED,0)=0 
AND ISNULL(DRAFT,0)=0))))

/* SET STARTFROM DATE TO RESTRICT SELECTION TO OPEN ROLLOVER AT THIS DATE*/
SET @dtSTARTFROM= CASE WHEN @strMODE='M' THEN 
'1 ' +DATENAME(M,@dtDATE) +' '+CONVERT(CHAR(4),YEAR(@dtDATE))
ELSE
'1 JANUARY 1900'
END
SET @ACCRUALPERIODDAYS=DATEDIFF(D,@dtSTARTFROM, @dtDATE)



/*@ACCRUETRANSACTIONS IS THE LIST OF TRANSACTIONS FOR WHICH AMOUNTS WILL BE ACCRUED*/
DECLARE @ACCRUETRANSACTIONS TABLE
(
TRANSIQID CHAR(32),
INVESTMENTINS CHAR(32),
STARTDATE DATETIME,
CLOSEDATE DATETIME,
DAYS1 INTEGER,
TYPEINVESTOP CHAR(20),
DAYSINACCRUALPERIOD INTEGER,
INVINSRATEKIND CHAR(20),
AMOUNT MONEY
)


INSERT @ACCRUETRANSACTIONS
SELECT 
IQID,
INVESTMENTINS
,DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE)) AS STARTDATE
,ISNULL(ACCRUEDATE,CLOSEDATE) AS CLOSEDATE
,DAYS1
,TYPEINVESTOP
,
/*DAYSINACCRUALPERIOD*/

CASE WHEN @INTERESTBASIS = -360 THEN

CASE WHEN ISNULL(ACCRUEDATE,CLOSEDATE)> @dtDATE THEN 
/*ENDS AFTER ACCRUAL PERIOD*/

[dbo].[fn360Interval](DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE)),@dtDATE)

WHEN DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE))<@dtSTARTFROM THEN
/*STARTS BEFORE ACCRUAL PERIOD*/
1+DATEDIFF(D,@dtSTARTFROM,ISNULL(ACCRUEDATE,CLOSEDATE))

ELSE
/*STARTS AND ENDS IN ACCRUAL PERIOD*/
ISNULL(DAYS1,0)
END

ELSE

CASE WHEN ISNULL(ACCRUEDATE,CLOSEDATE)> @dtDATE THEN 
/*ENDS AFTER ACCRUAL PERIOD*/
DATEDIFF(D, 
CASE WHEN DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE))<@dtSTARTFROM 
THEN DATEADD(D,-1,@dtSTARTFROM) 
ELSE DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE))END,@dtDATE)
WHEN DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE))<@dtSTARTFROM THEN
/*STARTS BEFORE ACCRUAL PERIOD*/
1+DATEDIFF(D,@dtSTARTFROM,ISNULL(ACCRUEDATE,CLOSEDATE))
ELSE
/*STARTS AND ENDS IN ACCRUAL PERIOD*/
ISNULL(DAYS1,0)
END

END
/*
NOTE - SET RATEKIND TO SIMPLE IF NOT SPECIFIC TO FORCE PROPORTION OF AMOUNT BY DAYS TO BE ACCRUED
*/
,ISNULL(INVINSRATEKIND,'SIMPLE')
,ISNULL(AMOUNTX2,AMOUNTX)
FROM VCINVESTMENTOP WHERE 
/*STARTS BEFORE END OF ACCRUAL MONTH*/
((DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE))<@dtDATE
/*CLOSES AFTER START OF ACCRUAL PERIOD*/
AND ISNULL(ACCRUEDATE,CLOSEDATE)>=@dtSTARTFROM))
AND INVESTMENTINS=@strINVESTMENTINS



AND  

(@stRTYPE= 'CAI' AND TYPEINVESTOP IN ('CAI','RISKINT') 
OR @strTYPE= 'CPI' AND TYPEINVESTOP IN ('CPI','RISKINTCAP')
OR TYPEINVESTOP=@strTYPE
)



AND ISNULL(IQDELETED,0)=0
AND ISNULL(CANCELLED,0)=0 
AND ISNULL(DRAFT,0)=0
ORDER BY CLOSEDATE


IF @strMODE<>'M'
BEGIN
DELETE FROM @ACCRUETRANSACTIONS WHERE CLOSEDATE<@dtDATE
END

SELECT TOP 1 @LASTTRANSACTIONCLOSEDATE=CLOSEDATE FROM @ACCRUETRANSACTIONS ORDER BY CLOSEDATE DESC
--SELECT * FROM @ACCRUETRANSACTIONS
/*LIST OF TRANSACTIONS MAKING UP THE BALANCE*/
DECLARE @TEMP TABLE
(
ELEMENTIQID CHAR(32),
TDATE DATETIME,
TCLOSE DATETIME,
TAPPLIED DATETIME,
TYPE CHAR(20),
PRINCIPAL MONEY,
TDRCR VARCHAR(1),
TCLASS1 VARCHAR(64)

) 
INSERT INTO @TEMP
SELECT 
IQID,
CASE WHEN ISNULL(DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE)),CLOSEDATE)<@dtINITIALADVANCE THEN @dtINITIALADVANCE ELSE
ISNULL(DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE)),CLOSEDATE)
END,
ISNULL(ACCRUEDATE,CLOSEDATE), 
CLOSEDATE,
TYPEINVESTOP,
CASE VCINVESTOPTYPE.CLASS1
WHEN 'EQUITY' THEN ISNULL(AMOUNT2,0)
WHEN 'LOANPRINCIPAL' THEN ISNULL(AMOUNT2,0)
WHEN 'LOANINTERESTS' THEN -ISNULL(AMOUNTX2,0)
WHEN 'CAPITALISEDINTERESTS' THEN ISNULL(AMOUNT2,0) -ISNULL(AMOUNTX2,0)
/*write off amount paid*/
WHEN 'WRITEOFF' THEN ISNULL(AMOUNT2,0)
ELSE 0 END,
VCINVESTOPTYPE.CREDITDEBIT,
VCINVESTOPTYPE.CLASS1


FROM VCINVESTMENTOP, VCINVESTOPTYPE WHERE
VCINVESTOPTYPE.FILTER=@ACCID
AND VCINVESTOPTYPE.CODE=VCINVESTMENTOP.TYPEINVESTOP
AND ISNULL(IQDELETED,0)=0
AND ISNULL(CANCELLED,0)=0
AND ISNULL(DRAFT,0)=0
AND INVESTMENTINS=@strINVESTMENTINS
AND (VCINVESTOPTYPE.CLASS1 NOT IN ('EQUITY','LOANINTERESTS','CAPITALISEDINTERESTS','WRITEOFF') 
OR ISNULL(DATEADD(D,-ISNULL(DAYS1,0),ISNULL(ACCRUEDATE,CLOSEDATE)),CLOSEDATE)<=@LASTTRANSACTIONCLOSEDATE)
AND 
ISNULL(CASE VCINVESTOPTYPE.CLASS1
WHEN 'EQUITY' THEN ISNULL(AMOUNT2,0)
WHEN 'LOANPRINCIPAL' THEN ISNULL(AMOUNT2,0)
WHEN 'LOANINTERESTS' THEN -ISNULL(AMOUNTX2,0)
WHEN 'CAPITALISEDINTERESTS' THEN ISNULL(AMOUNT2 ,0) -ISNULL(AMOUNTX2,0)
WHEN 'WRITEOFF' THEN ISNULL(AMOUNT2,0)
ELSE 0 END,0) <>0
AND TYPEINVESTOP NOT IN (SELECT ACCRUALTYPE FROM VCINVESTOPTYPE WHERE FILTER=@ACCID AND ACCRUALTYPE IS NOT NULL)
AND CHARINDEX('FXR',TYPEINVESTOP)=0
AND TYPEINVESTOP NOT IN ('WHTD')
IF (SELECT COUNT(*) FROM @TEMP)>0 

BEGIN

SET @dtSTARTFROM = CASE WHEN (SELECT MIN(TCLOSE) FROM @TEMP)<@dtSTARTFROM THEN 
@dtSTARTFROM ELSE (SELECT DATEDIFF(D,-1,MIN(TCLOSE)) FROM @TEMP) END
/*NOW A CROSS JOIN TABLE WITH THE AREAS DERIVED FOR EACH ELEMENT OF PRINCIPAL
FOR EACH TRANSACTION*/
DECLARE @ACCRUALS TABLE
(
TIQID CHAR(32),
INVESTMENTINS CHAR(32),
STARTDATE DATETIME,
CLOSEDATE DATETIME,
DAYS1 INTEGER,
TYPEINVESTOP CHAR(20),
DAYSINACCRUALPERIOD INTEGER,
INVINSRATEKIND CHAR(20),
AMOUNT MONEY,
ELEMENTIQID CHAR(32),
TDATE DATETIME,
TCLOSE DATETIME,
TAPPLIED DATETIME,
TYPE CHAR(20),
PRINCIPAL FLOAT(15),
TDRCR VARCHAR(1),
TCLASS1 VARCHAR(64),
INTERESTAREA FLOAT,
ACCRUALAREA FLOAT
)

INSERT INTO @ACCRUALS
SELECT TR.*, TA.*,
/*INTEREST AREA*/
TA.PRINCIPAL*
CASE WHEN TA.TAPPLIED>=TR.CLOSEDATE  OR TA.TYPE IN ('CAI','CAIADJ','TRIFSEC','TRPPCAID','TRLTSBCAI','TRMMCAI','TRFXPREM') THEN 0
ELSE 
    CASE WHEN @INTERESTBASIS = -360 THEN
        dbo.fn360Interval(CASE WHEN TA.TAPPLIED<TR.STARTDATE THEN TR.STARTDATE ELSE TA.TAPPLIED END,TR.CLOSEDATE)
    ELSE
	    DATEDIFF(D,CASE WHEN TA.TAPPLIED<TR.STARTDATE THEN TR.STARTDATE ELSE TA.TAPPLIED END,TR.CLOSEDATE)
	END
END
,
/*ACCRUAL AREA*/
TA.PRINCIPAL*
CASE WHEN TA.TAPPLIED>@dtDATE OR TA.TAPPLIED>=TR.CLOSEDATE  OR TA.TYPE IN ('CAI','CAIADJ','TRIFSEC','TRPPCAID','TRLTSBCAI','TRMMCAI','TRFXPREM') THEN 0
WHEN TR.STARTDATE>TA.TAPPLIED THEN
CASE WHEN @INTERESTBASIS = -360 THEN
	dbo.fn360Interval(
	CASE WHEN TR.STARTDATE<@dtSTARTFROM THEN DATEADD(D,-1,@dtSTARTFROM) ELSE TR.STARTDATE END,
	CASE WHEN TR.CLOSEDATE<@dtDATE THEN TR.CLOSEDATE ELSE @dtDATE END)
ELSE
	DATEDIFF(D,
	CASE WHEN TR.STARTDATE<@dtSTARTFROM THEN DATEADD(D,-1,@dtSTARTFROM) ELSE TR.STARTDATE END,
	CASE WHEN TR.CLOSEDATE<@dtDATE THEN TR.CLOSEDATE ELSE @dtDATE END)
END

ELSE 

CASE WHEN @INTERESTBASIS = -360 THEN
	dbo.fn360Interval(
	CASE WHEN TA.TAPPLIED<@dtSTARTFROM THEN DATEADD(D,-1,@dtSTARTFROM) ELSE TA.TAPPLIED END,
	CASE WHEN TR.CLOSEDATE<@dtDATE THEN TR.CLOSEDATE ELSE @dtDATE END)
ELSE
	DATEDIFF(D,
	CASE WHEN TA.TAPPLIED<@dtSTARTFROM THEN DATEADD(D,-1,@dtSTARTFROM) ELSE TA.TAPPLIED END,
	CASE WHEN TR.CLOSEDATE<@dtDATE THEN TR.CLOSEDATE ELSE @dtDATE END)
END


END
FROM @ACCRUETRANSACTIONS TR ,@TEMP TA

/*
REMOVE ENTRIES FROM HERE TO REPRESENT THE CONTRIBUTION TO INTEREST WHERE A PRINCIPAL MOVEMENT
IS ACCOMPANIED BY AN INTEREST TRANSACTION RELATING TO THE AMOUNT ADVANCED ON THE 
DATE OF THE ADVANCE. THIS AVOIDS SKEWING THE INTEREST DERIVATION BY TAKING INTO ACCOUNT
A PRINCIPAL MOVEMENT THAT HAS NOT AFFECTED THE INTEREST TRANSACTION (ICG FIRST CREDIT)
*/

DELETE FROM @ACCRUALS  WHERE 
INVINSRATEKIND<>'LOANINTFIXED' 
AND TCLASS1='LOANPRINCIPAL'
AND (SELECT COUNT(*) FROM VCINVESTMENTOP T WHERE 
ISNULL(T.CANCELLED,0)=0
AND ISNULL(T.IQDELETED,0)=0
AND ISNULL(T.DRAFT,0)=0
AND T.INVESTMENTINS=@strINVESTMENTINS
AND T.TYPEINVESTOP=@strTYPE
AND DATEADD(D,-ISNULL(T.DAYS1,0),ISNULL(T.ACCRUEDATE,T.CLOSEDATE))=TAPPLIED
AND ISNULL(ACCRUEDATE,CLOSEDATE)>STARTDATE
AND T.INVINSRATEKIND IN ('LOANINTFIXED')
)
>0



DECLARE @TEMP3 TABLE
(
CALCACCRUAL MONEY
)
INSERT INTO @TEMP3

SELECT 
CASE ISNULL(INVINSRATEKIND,'LOANINTERESTS')
WHEN 'LOANINTERESTS' THEN
CASE WHEN TYPEINVESTOP IN ('TRIFSEC') THEN
AMOUNT*DAYSINACCRUALPERIOD/DAYS1
ELSE

	CASE WHEN ISNULL((SELECT SUM(INTERESTAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID),0)=0 
	THEN 0
	ELSE
	AMOUNT*
	ISNULL(
	/*SUM OF AREAS IN ACCRUAL PERIOD*/
	ISNULL((SELECT SUM(ACCRUALAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID),0)
	/
	/*SUM OF AREAS IN INTEREST PERIOD*/
	ISNULL((SELECT SUM(INTERESTAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID),0)
	,0)
	END
END

WHEN 'LOANINTVAR' THEN
CASE WHEN
(
/*ELEMENTS PRIOR TO START INCLUDING ALL TYPES*/

ISNULL((SELECT SUM(T.INTERESTAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND (T.TCLOSE<=T.STARTDATE)),0)
+
ISNULL((SELECT SUM(T.INTERESTAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND T.TYPE IN ('ADV','REP','PEQ','SEQ','SIE','SOE','EWO','DWO','SID','SOD') AND  T.TCLOSE>T.STARTDATE AND T.TCLOSE<T.CLOSEDATE),0)
)
=0 THEN 0 
ELSE
AMOUNT*
ISNULL(
/*SUM OF AREAS IN ACCRUAL PERIOD*/
(
ISNULL((SELECT SUM(T.ACCRUALAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID 
AND T.TCLOSE<=T.STARTDATE
),0)
+
ISNULL((SELECT SUM(T.ACCRUALAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND T.TYPE IN ('ADV','REP','PEQ','SEQ','SIE','SOE','EWO','DWO','SID','SOD') AND  T.TCLOSE>T.STARTDATE AND T.TCLOSE<T.CLOSEDATE),0)
)
/
/*SUM OF AREAS IN INTEREST PERIOD*/

(
/*ELEMENTS PRIOR TO START INCLUDING ALL TYPES*/
ISNULL((SELECT SUM(T.INTERESTAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND (T.TCLOSE<=T.STARTDATE)),0)
+
ISNULL((SELECT SUM(T.INTERESTAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND T.TYPE IN ('ADV','REP','PEQ','SEQ','SIE','SOE','EWO','DWO','SID','SOD') AND  T.TCLOSE>T.STARTDATE AND T.TCLOSE<T.CLOSEDATE),0)
)
,0)

END

WHEN 'LOANAMNTONLY' THEN
AMOUNT*
ISNULL(
/*SUM OF AREAS IN ACCRUAL PERIOD*/
ISNULL((SELECT SUM(ACCRUALAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND TYPE NOT IN ('CPI','INCCAPPIK','INCACDPIK','DECCAPPIK','DECACDPIK','CPIR')),0)
/
ISNULL((SELECT SUM(INTERESTAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND TYPE NOT IN ('CPI','INCCAPPIK','INCACDPIK','DECCAPPIK','DECACDPIK','CPIR')),0)
/*SUM OF AREAS IN INTEREST PERIOD*/

,0)
WHEN 'LOANINTCAPROLL' THEN
CASE WHEN ISNULL((SELECT SUM(INTERESTAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND TYPE IN ('CPI','INCCAPPIK','INCCAPPIK','DECACDPIK','DECCAPPIK')
AND TCLOSE=STARTDATE),0)=0 THEN 0 ELSE
AMOUNT*
ISNULL(


/*SUM OF AREAS IN ACCRUAL PERIOD*/
ISNULL((SELECT SUM(ACCRUALAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND TYPE IN ('CPI','INCCAPPIK','INCCAPPIK','DECACDPIK','DECCAPPIK')
AND TCLOSE=STARTDATE),0)
/
ISNULL((SELECT SUM(INTERESTAREA) FROM @ACCRUALS T WHERE T.TIQID=TRANSIQID
AND TYPE IN ('CPI','INCCAPPIK','INCCAPPIK','DECACDPIK','DECCAPPIK')
AND TCLOSE=STARTDATE),0)
/*SUM OF AREAS IN INTEREST PERIOD*/

,0)
END
ELSE 
/*CATCH ALL - PROPORTION OF DAYS IN ACCRUAL PERIOD TO DAYS IN INTEREST PERIOD*/
AMOUNT*
ISNULL((SELECT 1000000*DAYSINACCRUALPERIOD/DAYS1 FROM @ACCRUALS WHERE 
ELEMENTIQID=TRANSIQID AND TIQID=TRANSIQID),0)/1000000
 END 
AS CALCACCRUAL
FROM @ACCRUETRANSACTIONS
WHERE 
NOT (
/*DISCARD IF:*/
/*STARTS AFTER THE REQUIRED PERIOd*/
(STARTDATE> @dtDATE) 
OR 
/*ENDS BEFORE REQUIRED PERIOD*/
(CLOSEDATE<=@dtSTARTFROM)
)
AND INVESTMENTINS=@strINVESTMENTINS
AND TYPEINVESTOP=@strTYPE
ORDER BY CLOSEDATE

/*NOW ADD ANY TRANSACTIONS THAT HAVE BEEN ACCRUED AND ARE NOT YET APPLIED AT THE END DATE*/
INSERT @TEMP3
SELECT SUM(CASE WHEN TYPEINVESTOP IN ('DECACDPIK','DECACDPIYC') THEN -AMOUNT2 ELSE AMOUNTX2 END ) FROM VCINVESTMENTOP
WHERE 
/*WAS ACCRUED TO A DATE BEFORE THE START OF THE PERIOD IN QUESTION*/
(

(ISNULL(ACCRUEDATE,'31 DECEMBER 2999')<@dtDATE
AND TYPEINVESTOP=@strTYPE
/*CLOSES AFTER END OF ACCRUAL PERIOD*/
AND CLOSEDATE>=@dtDATE)

OR
/*COLLECT CAIADJ AT THE END OF THE RO PERIOD FOR CASH ACCRUALS ONLY*/
(CLOSEDATE <=(SELECT MAX(CLOSEDATE) FROM @ACCRUETRANSACTIONS)
AND TYPEINVESTOP='CAIADJ'
AND @strTYPE='CAI'
/*CLOSES AFTER END OF ACCRUAL PERIOD*/
AND CLOSEDATE>=@dtDATE
AND ISNULL(ACCOUNTINGDATE,CLOSEDATE) <=@dtDATE)
OR

(
TYPEINVESTOP IN ('INCACDPIK','DECACDPIK','INCACDPIYC','DECACDPIYC')
AND CLOSEDATE <=(SELECT MAX(CLOSEDATE) FROM @ACCRUETRANSACTIONS)
AND CLOSEDATE >=@dtDATE
AND ISNULL(ACCOUNTINGDATE,CLOSEDATE) <=@dtDATE

AND @stRTYPE IN ('CPI')
)

)

AND INVESTMENTINS=@strINVESTMENTINS

AND ISNULL(IQDELETED,0)=0
AND ISNULL(CANCELLED,0)=0 
AND ISNULL(DRAFT,0)=0


SELECT @RESULT=(SELECT SUM(CALCACCRUAL) FROM @TEMP3)
END

ELSE
BEGIN
SET @RESULT=0
END
RETURN ISNULL(@RESULT,0)
END


