=========
PRINCIPAL
=========

isnull(
(SELECT -SUM(SUB.AMOUNTXX) 
FROM    (SELECT T.AMOUNT2 AS AMOUNTXX 
         FROM   VCINVESTMENTOP T               ,VCINVESTOPTYPE T1    
		 WHERE ??FILTER(T)??          AND 
		 ??FILTERLKP(VCINVESTOPTYPE,T1)??           AND 
		 T1.CODE = T.TYPEINVESTOP           AND 
		 (T.DRAFT=0 OR T.DRAFT IS NULL)           AND 
		 (T.CANCELLED=0 OR T.CANCELLED IS NULL)           AND 
		 (T.IQDELETED=0 OR T.IQDELETED IS NULL)              AND  
		 T.INVESTMENTINS=[VC/Investment/Instrument.IQId]   AND 
		 T.CLOSEDATE <=%RDATE           AND 
		 T1.CLASS1 IN('WRITEOFF', 'LOANPRINCIPAL','EQUITY' )) SUB ),0)
		 
		 
===========
CAPITALISED
===========
		 
ISNULL((
SELECT   SUM(SUB.AMOUNTXX)   
FROM            (SELECT              (CASE WHEN T.TYPEINVESTOP IN ('CPIR','DECACDPIK','DECCAPPIK','CSHCONVRED','RPWO','DECACDPIYC','DECCAPPIYC','CSHCONV')  THEN -1          ELSE 1          END)   * 
                                   (  CASE WHEN T.TYPEINVESTOP IN ('CPI','INCCAPPIK','INCACDPIK','CPINC','INCACDPIYC','INCCAPPIYC','RISKINTCAP')            THEN T.AMOUNTX2  ELSE T.AMOUNT2  END)          AS AMOUNTXX
				FROM   VCINVESTMENTOP T               
				WHERE ISNULL(T.IQDELETED,0)=0 AND 
				ISNULL(T.CANCELLED,0)=0 AND 
				ISNULL(T.DRAFT,0)=0 AND 
				INVESTMENTINS=[VC/Investment/Instrument.IQId]       AND 
				T.CLOSEDATE <%RDATE   AND 
				TYPEINVESTOP IN ('CPIR','DECACDPIK','DECCAPPIK','CPI','INCCAPPIK','INCACDPIK','CPINC','RPWO','CSHCONVRED','CSHCONV','INCACDPIYC','INCCAPPIYC','DECACDPIYC','DECCAPPIYC','RISKINTCAP')     ) SUB),0)
				
				
======
CPIACC		
======
				
dbo.fnFVACCRUALS(%RDATE,'CPI',[VC/Investment/Instrument.IQId],'X') +
ISNULL((SELECT   SUM(SUB.AMOUNTXX)   
        FROM            (SELECT              (CASE WHEN T.TYPEINVESTOP IN ('DECACDPIK','DECACDPIYC')             THEN -1          ELSE 1          END)   *
                                       		 (CASE WHEN T.TYPEINVESTOP IN ('INCCAPPIK','INCACDPIK','INCACDPIYC') THEN T.AMOUNTX2  ELSE T.AMOUNT2  END)          AS AMOUNTXX  
						FROM   VCINVESTMENTOP T 
						WHERE ISNULL(T.IQDELETED,0)=0 AND 
						ISNULL(T.CANCELLED,0)=0 AND 
						ISNULL(T.DRAFT,0)=0 AND 
						INVESTMENTINS=[VC/Investment/Instrument.IQId]       AND 
						T.CLOSEDATE >%RDATE and 
						ISNULL(T.ACCOUNTINGDATE,T.ACCRUEDATE)<=%RDATE  AND 
						TYPEINVESTOP IN ('DECACDPIK','INCACDPIK','INCACDPIYC','DECACDPIYC')     ) SUB),0)
						
						
======
CAIACC
======

dbo.fnFVACCRUALS(%RDATE,'CAI',[VC/Investment/Instrument.IQId],'X')
